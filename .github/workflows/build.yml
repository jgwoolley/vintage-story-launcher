name: Build Native Installers

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            artifact-type: windows
          - os: ubuntu-latest
            artifact-type: linux
          - os: macos-latest
            artifact-type: macos

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build Fat JAR with Maven
        run: mvn clean package

      # Install RPM tools on Ubuntu
      - name: Install RPM dependencies
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y rpm

      # 1. WINDOWS: Build MSI and Portable EXE
      - name: Package Windows MSI
        if: matrix.os == 'windows-latest'
        run: |
          jpackage --input target/ --dest output/ --name VSLauncher --main-jar vintagestory-launcher-0.1.1.jar --main-class com.yelloowstone.vslauncher.Launcher --type msi --win-dir-chooser --win-shortcut --win-menu
          
          # For a "portable" EXE, we create an app-image (folder containing exe + runtime)
          jpackage --input target/ --dest output/portable/ --name VSLauncherPortable --main-jar vintagestory-launcher-0.1.1.jar --main-class com.yelloowstone.vslauncher.Launcher --type app-image

      # 2. LINUX: Build DEB and RPM
      - name: Package Linux DEB & RPM
        if: matrix.os == 'ubuntu-latest'
        run: |
          jpackage --input target/ --dest output/ --name vslauncher --main-jar vintagestory-launcher-0.1.1.jar --main-class com.yelloowstone.vslauncher.Launcher --type deb --linux-shortcut
          jpackage --input target/ --dest output/ --name vslauncher --main-jar vintagestory-launcher-0.1.1.jar --main-class com.yelloowstone.vslauncher.Launcher --type rpm

      # 3. MACOS: Build DMG
      - name: Package MacOS DMG
        if: matrix.os == 'macos-latest'
        run: |
          jpackage --input target/ --dest output/ --name VSLauncher --main-jar vintagestory-launcher-0.1.1.jar --main-class com.yelloowstone.vslauncher.Launcher --type dmg

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: installers-${{ matrix.artifact-type }}
          path: output/